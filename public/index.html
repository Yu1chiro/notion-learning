<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-cyan-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white/70 backdrop-blur-md shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-sticky-note text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">My Personal Notes</h1>
                        <p class="text-sm text-gray-500">Catatan Pribadi Anda</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500" id="currentDate"></div>
                    <div class="hidden font-semibold text-indigo-600" id="currentTime"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Calendar Section -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-gray-800">Kalender Notes</h2>
                <div class="flex items-center space-x-4">
                    <button id="prevMonth" class="p-2 rounded-lg bg-indigo-100 hover:bg-indigo-200 transition-colors">
                        <i class="fas fa-chevron-left text-indigo-600"></i>
                    </button>
                    <div class="text-xl font-semibold text-gray-700" id="monthYear"></div>
                    <button id="nextMonth" class="p-2 rounded-lg bg-indigo-100 hover:bg-indigo-200 transition-colors">
                        <i class="fas fa-chevron-right text-indigo-600"></i>
                    </button>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-2 mb-4">
                <div class="text-center font-semibold text-gray-500 py-3">Min</div>
                <div class="text-center font-semibold text-gray-500 py-3">Sen</div>
                <div class="text-center font-semibold text-gray-500 py-3">Sel</div>
                <div class="text-center font-semibold text-gray-500 py-3">Rab</div>
                <div class="text-center font-semibold text-gray-500 py-3">Kam</div>
                <div class="text-center font-semibold text-gray-500 py-3">Jum</div>
                <div class="text-center font-semibold text-gray-500 py-3">Sab</div>
            </div>
            <div class="grid grid-cols-7 gap-2" id="calendarDates"></div>
        </div>

        <!-- Recent Notes Section -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Catatan Terbaru</h3>
            <div id="recentNotes" class="space-y-4">
                <!-- Recent notes will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white/70 backdrop-blur-md mt-16 py-6">
        <div class="container mx-auto px-6 text-center text-gray-600">
            <p>&copy; 2025 My Personal Notes. Dibuat dengan ❤️ untuk pembelajaran.</p>
        </div>
    </footer>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="animate-spin w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-700 font-medium">Memuat data...</p>
            </div>
        </div>
    </div>

    <script>
        class PersonalNotesApp {
            constructor() {
                this.currentDate = new Date();
                this.notes = {};
                this.initializeApp();
            }

            async initializeApp() {
                this.updateCurrentTime();
                this.setupEventListeners();
                await this.loadNotes();
                this.renderCalendar();
                this.loadRecentNotes();
                
                // Update time setiap detik
                setInterval(() => this.updateCurrentTime(), 1000);
            }

            async updateCurrentTime() {
                try {
                    const response = await fetch('/api/current-time-wita');
                    const data = await response.json();
                    const witaTime = new Date(data.currentTime);
                    
                    document.getElementById('currentTime').textContent = 
                        witaTime.toLocaleTimeString('id-ID', { 
                            hour: '2-digit', 
                            minute: '2-digit',
                            second: '2-digit',
                            timeZone: 'Asia/Makassar'
                        });
                    
                    document.getElementById('currentDate').textContent = 
                        witaTime.toLocaleDateString('id-ID', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            timeZone: 'Asia/Makassar'
                        });
                } catch (error) {
                    console.error('Error updating time:', error);
                }
            }

            setupEventListeners() {
                document.getElementById('prevMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.renderCalendar();
                });

                document.getElementById('nextMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.renderCalendar();
                });
            }

            async loadNotes() {
                try {
                    const response = await fetch('/api/notes');
                    if (response.ok) {
                        this.notes = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading notes:', error);
                }
            }

            renderCalendar() {
                const monthNames = [
                    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                ];

                document.getElementById('monthYear').textContent = 
                    `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;

                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
                const firstDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                const calendarDates = document.getElementById('calendarDates');
                calendarDates.innerHTML = '';

                // Empty cells untuk hari sebelum tanggal 1
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'h-16';
                    calendarDates.appendChild(emptyCell);
                }

                // Render semua tanggal dalam bulan
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${this.currentDate.getFullYear()}-${String(this.currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const hasNote = this.notes[dateStr];
                    const isToday = this.isToday(new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day));

                    const dayCell = document.createElement('div');
                    dayCell.className = `h-16 p-2 rounded-lg cursor-pointer transition-all duration-200 border-2 ${
                        isToday 
                            ? 'bg-indigo-200 text-gray-800 border-indigo-300 shadow-lg' 
                            : hasNote 
                                ? 'bg-green-100 border-green-300 hover:bg-green-200' 
                                : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                    }`;

                    dayCell.innerHTML = `
                        <div class="text-center">
                            <div class="font-semibold">${day}</div>
                            ${hasNote ? '<div class="w-2 h-2 bg-green-500 rounded-full mx-auto mt-1"></div>' : ''}
                        </div>
                    `;

                    dayCell.addEventListener('click', () => {
                        window.location.href = `/create-note?date=${dateStr}`;
                    });

                    calendarDates.appendChild(dayCell);
                }
            }

            isToday(date) {
                const today = new Date();
                return date.toDateString() === today.toDateString();
            }

            loadRecentNotes() {
                const recentNotesContainer = document.getElementById('recentNotes');
                const noteEntries = Object.entries(this.notes);

                if (noteEntries.length === 0) {
                    recentNotesContainer.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-sticky-note text-gray-300 text-6xl mb-4"></i>
                            <p class="text-gray-500 text-lg">Belum ada catatan. Klik tanggal di kalender untuk membuat catatan pertama Anda!</p>
                        </div>
                    `;
                    return;
                }

                // Sort berdasarkan tanggal terbaru
                const sortedNotes = noteEntries.sort((a, b) => new Date(b[0]) - new Date(a[0]));
                const recentNotes = sortedNotes.slice(0, 5); // Ambil 5 terakhir

                recentNotesContainer.innerHTML = recentNotes.map(([date, note]) => {
                    const formattedDate = new Date(date).toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    return `
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-100 hover:shadow-lg transition-shadow cursor-pointer"
                             onclick="window.location.href='/create-note?date=${date}'">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg text-gray-800 mb-2">${note.title}</h4>
                                    <p class="text-gray-600 mb-3 line-clamp-2">${note.description || 'Tidak ada deskripsi'}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                        <span><i class="fas fa-calendar mr-1"></i>${formattedDate}</span>
                                        ${note.vocabulary && note.vocabulary.length > 0 ? `<span><i class="fas fa-book mr-1"></i>${note.vocabulary.length} kosakata</span>` : ''}
                                        ${note.youtubeLink ? '<span><i class="fab fa-youtube mr-1"></i>Video</span>' : ''}
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <i class="fas fa-chevron-right text-indigo-400"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            showLoading() {
                document.getElementById('loadingModal').classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loadingModal').classList.add('hidden');
            }
        }

        // Initialize app when DOM loaded
        document.addEventListener('DOMContentLoaded', () => {
            new PersonalNotesApp();
        });
    </script>
</body>
</html>